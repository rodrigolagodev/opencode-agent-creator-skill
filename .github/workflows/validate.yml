name: Validate Templates

on:
  pull_request:
    paths:
      - 'templates/**'
      - 'references/**'
      - 'workflows/**'
      - 'SKILL.md'
  push:
    branches:
      - main

jobs:
  validate-yaml:
    name: Validate YAML Frontmatter
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install PyYAML
        run: pip install pyyaml
      
      - name: Validate template YAML
        run: |
          python3 << 'EOF'
          import yaml
          import sys
          from pathlib import Path
          
          errors = []
          templates_dir = Path('templates')
          
          for template in templates_dir.glob('*.md'):
              print(f"Validating {template.name}...")
              
              with open(template, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # Extract frontmatter
              if not content.startswith('---'):
                  errors.append(f"{template.name}: Missing frontmatter")
                  continue
              
              parts = content.split('---', 2)
              if len(parts) < 3:
                  errors.append(f"{template.name}: Invalid frontmatter structure")
                  continue
              
              try:
                  frontmatter = yaml.safe_load(parts[1])
                  
                  # Check required fields
                  if 'description' not in frontmatter:
                      errors.append(f"{template.name}: Missing 'description' field")
                  
                  # Check for example blocks
                  if '<example>' not in frontmatter.get('description', ''):
                      errors.append(f"{template.name}: Missing <example> block in description")
                  
                  # Check tools config
                  if 'tools' in frontmatter and 'skill' not in frontmatter['tools']:
                      errors.append(f"{template.name}: Missing 'skill: true' in tools")
                  
                  print(f"  ✓ {template.name} is valid")
                  
              except yaml.YAMLError as e:
                  errors.append(f"{template.name}: Invalid YAML - {str(e)}")
          
          if errors:
              print("\n❌ Validation errors found:")
              for error in errors:
                  print(f"  - {error}")
              sys.exit(1)
          else:
              print("\n✅ All templates validated successfully!")
          EOF

  check-links:
    name: Check Markdown Links
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check internal links
        run: |
          echo "Checking for broken internal links..."
          
          # Simple link checker for internal references
          find . -name '*.md' -type f | while read -r file; do
            echo "Checking $file..."
            
            # Extract markdown links [text](path)
            grep -oP '\[.*?\]\(\K[^)]+(?=\))' "$file" | while read -r link; do
              # Skip external links
              if [[ $link =~ ^https?:// ]]; then
                continue
              fi
              
              # Check if internal file exists
              if [[ ! -e "$link" && ! -e "$(dirname "$file")/$link" ]]; then
                echo "  ⚠️  Broken link in $file: $link"
              fi
            done
          done
          
          echo "✅ Link check completed"

  lint-markdown:
    name: Lint Markdown
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Basic markdown checks
        run: |
          echo "Running basic markdown quality checks..."
          
          # Check for trailing whitespace
          if grep -r '[[:blank:]]$' --include='*.md' .; then
            echo "❌ Found trailing whitespace"
            exit 1
          fi
          
          echo "✅ Markdown checks passed"
